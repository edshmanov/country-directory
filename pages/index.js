import { useState, useRef, useEffect } from "react";
import Head from "next/head";
import { CATS, STORES as SEED } from "../src/data";
import { T, LANGS } from "../src/i18n";
const FH = "var(--hd)", FB = "var(--bd)";
function PhotoPicker({ preview, setPreview, label, subLabel }) {
  const ref = useRef(null);
  const uid = "ph-" + Math.random().toString(36).slice(2, 6);
  const handleFile = (e) => { const f = e.target.files?.[0]; if (!f) return; const r = new FileReader(); r.onload = (ev) => setPreview(ev.target.result); r.readAsDataURL(f); };
  return (<div style={{ marginBottom: 4 }}><p style={{ fontSize: 14, fontWeight: 700, color: "#3d2c1e", margin: "0 0 8px" }}>ğŸ“· {label}</p><input type="file" accept="image/*" id={uid} ref={ref} onChange={handleFile} style={{ position: "absolute", width: 1, height: 1, opacity: 0 }} />{preview ? (<div style={{ position: "relative", borderRadius: 12, overflow: "hidden", border: "3px solid var(--gn)" }}><img src={preview} alt="" style={{ width: "100%", height: 200, objectFit: "cover", display: "block" }} /><div style={{ position: "absolute", bottom: 0, left: 0, right: 0, background: "rgba(74,124,89,0.92)", color: "#fff", padding: 8, fontSize: 14, fontWeight: 700, textAlign: "center" }}>âœ… {subLabel}</div><button onClick={(e) => { e.preventDefault(); setPreview(null); }} style={{ position: "absolute", top: 8, right: 8, background: "rgba(0,0,0,0.6)", color: "#fff", border: "none", borderRadius: "50%", width: 32, height: 32, cursor: "pointer", fontSize: 16, fontWeight: 700, padding: 0 }}>âœ•</button></div>) : (<label htmlFor={uid} style={{ display: "flex", flexDirection: "column", alignItems: "center", width: "100%", padding: "28px 14px", background: "#f0ebe3", border: "3px dashed #8b7355", borderRadius: 12, cursor: "pointer", textAlign: "center", gap: 6 }}><span style={{ fontSize: 44 }}>ğŸ“·</span><span style={{ fontSize: 15, color: "#5c4a3a", fontWeight: 700 }}>Tap to add photo</span><span style={{ fontSize: 12, color: "#8b7355" }}>JPG, PNG, HEIC</span></label>)}</div>);
}
export default function Home() {
  const [lang, setLang] = useState("en");
  const [view, setView] = useState("home");
  const [catF, setCatF] = useState(null);
  const [sel, setSel] = useState(null);
  const [q, setQ] = useState("");
  const [stores, setStores] = useState(SEED);
  const [ok, setOk] = useState(false);
  const [form, setForm] = useState({ name: "", addr: "", phone: "", cat: "", desc: "", hours: "" });
  const [info, setInfo] = useState({ yourName: "", comment: "" });
  const [preview, setPreview] = useState(null);
  const [preview2, setPreview2] = useState(null);
  const [saving, setSaving] = useState(false);
  const t = T[lang];
  useEffect(() => { fetch("/api/stores").then(r => r.json()).then(setStores).catch(() => {}); }, []);
  const cn = (c) => c[lang];
  const sn = (catId, subEn) => { const c = CATS.find(x => x.id === catId); if (!c) return subEn; const s = c.subs.find(x => x.en === subEn); return s ? s[lang] : subEn; };
  const pill = (bg, fg, text) => <span key={text} style={{ background: bg, color: fg, padding: "3px 10px", borderRadius: 12, fontSize: 11, fontWeight: 600, display: "inline-block" }}>{text}</span>;
  const filtered = stores.filter(s => { if (catF && s.cat !== catF) return false; if (!q) return true; const ql = q.toLowerCase(); return s.name.toLowerCase().includes(ql) || (s.en||"").toLowerCase().includes(ql) || (s.uk||"").toLowerCase().includes(ql) || (s.ru||"").toLowerCase().includes(ql) || s.addr.toLowerCase().includes(ql) || (s.subs||[]).some(x => x.toLowerCase().includes(ql)) || (s.tags||[]).some(x => x.toLowerCase().includes(ql)); });
  const apiSave = async (store) => { try { await fetch("/api/stores", { method: "POST", headers: { "Content-Type": "application/json" }, body: JSON.stringify(store) }); } catch(e) {} };
  const submitPlace = async () => { if (!form.name || !form.addr) return; setSaving(true); const photos = preview ? [{ url: preview, caption: "", status: "pending" }] : []; const ns = { id: "u" + Date.now(), name: form.name, cat: form.cat || "goods", subs: [], addr: form.addr, phone: form.phone, en: form.desc, uk: form.desc, ru: form.desc, hen: form.hours, huk: form.hours, hru: form.hours, tags: [], photos }; await apiSave(ns); setStores(p => [...p, ns]); setSaving(false); setOk(true); setTimeout(() => { setView("home"); setOk(false); setForm({ name: "", addr: "", phone: "", cat: "", desc: "", hours: "" }); setPreview(null); }, 2000); };
  const submitInfo = async () => { if (!info.comment && !preview2) return; setSaving(true); if (sel) { const newP = preview2 ? [{ url: preview2, caption: info.comment, status: "pending" }] : []; const up = { ...sel, photos: [...(sel.photos || []), ...newP] }; await apiSave(up); setStores(p => p.map(s => s.id === sel.id ? up : s)); setSel(up); } setSaving(false); setOk(true); setTimeout(() => { setView("detail"); setOk(false); setInfo({ yourName: "", comment: "" }); setPreview2(null); }, 2500); };
  const LangSw = ({ dark }) => (<div style={{ display: "flex", background: dark ? "rgba(255,255,255,0.12)" : "#f0ebe3", borderRadius: 20, overflow: "hidden", border: dark ? "1px solid rgba(255,255,255,0.25)" : "1px solid #d4c9b8", flexShrink: 0 }}>{LANGS.map((l, i) => (<button key={l.code} onClick={() => setLang(l.code)} style={{ background: lang === l.code ? (dark ? "rgba(255,255,255,0.3)" : "#3d2c1e") : "transparent", color: lang === l.code ? "#fff" : (dark ? "rgba(255,255,255,0.7)" : "#8b7355"), border: "none", padding: "6px 10px", fontSize: 12, fontWeight: 700, cursor: "pointer", borderRight: i < LANGS.length - 1 ? (dark ? "1px solid rgba(255,255,255,0.15)" : "1px solid #d4c9b8") : "none" }}>{l.flag ? l.flag + " " : ""}{l.label}</button>))}</div>);
  return (<><Head><title>Country Directory â€” Indiana</title><meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1" /><meta name="theme-color" content="#3d2c1e" /><link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>ğŸ¡</text></svg>" /></Head><div style={{ maxWidth: 480, margin: "0 auto", minHeight: "100vh" }}>
    {view === "addPlace" && (<div style={{ padding: 16 }}>{ok ? <div style={{ textAlign: "center", padding: 60 }}><div style={{ fontSize: 56, marginBottom: 16 }}>âœ…</div><p style={{ fontSize: 17, fontWeight: 600 }}>{t.thanks}</p></div> : (<div><button onClick={() => setView("home")} style={{ background: "none", border: "none", color: "var(--md)", cursor: "pointer", fontSize: 15, padding: "8px 0", fontWeight: 600 }}>â† {t.cancel}</button><h2 style={{ fontFamily: FH, fontSize: 22, margin: "8px 0 20px" }}>â• {t.addPlaceTitle}</h2><div style={{ display: "flex", flexDirection: "column", gap: 14 }}><label style={{ fontSize: 13, fontWeight: 700, color: "#5c4a3a" }}>{t.name} *<input value={form.name} onChange={e => setForm({...form, name: e.target.value})} placeholder="Yoder's Farm" /></label><label style={{ fontSize: 13, fontWeight: 700, color: "#5c4a3a" }}>{t.address} *<input value={form.addr} onChange={e => setForm({...form, addr: e.target.value})} placeholder="1234 County Rd, City, IN" /></label><label style={{ fontSize: 13, fontWeight: 700, color: "#5c4a3a" }}>{t.phone}<input value={form.phone} onChange={e => setForm({...form, phone: e.target.value})} placeholder="(260) 555-1234" /></label><label style={{ fontSize: 13, fontWeight: 700, color: "#5c4a3a" }}>{t.category}<select value={form.cat} onChange={e => setForm({...form, cat: e.target.value})}><option value="">{t.selectCat}</option>{CATS.map(c => <option key={c.id} value={c.id}>{c.icon} {c[lang]}</option>)}</select></label><label style={{ fontSize: 13, fontWeight: 700, color: "#5c4a3a" }}>{t.descLabel}<textarea value={form.desc} onChange={e => setForm({...form, desc: e.target.value})} rows={3} style={{ resize: "vertical" }} /></label><label style={{ fontSize: 13, fontWeight: 700, color: "#5c4a3a" }}>{t.hours}<input value={form.hours} onChange={e => setForm({...form, hours: e.target.value})} placeholder="Mon-Sat 8AM-5PM" /></label><PhotoPicker preview={preview} setPreview={setPreview} label={t.addPhoto + " â€” " + t.photoOptional} subLabel={t.photoSelected} /><button onClick={submitPlace} disabled={!form.name || !form.addr || saving} style={{ padding: 14, background: (!form.name || !form.addr) ? "#c4b59a" : "var(--gn)", color: "#fff", border: "none", borderRadius: 10, fontSize: 16, fontWeight: 700, cursor: (!form.name || !form.addr) ? "default" : "pointer" }}>{saving ? t.saving : t.submit}</button></div></div>)}</div>)}
    {view === "addInfo" && (<div style={{ padding: 16 }}>{ok ? <div style={{ textAlign: "center", padding: 60 }}><div style={{ fontSize: 56, marginBottom: 16 }}>âœ…</div><p style={{ fontSize: 17, fontWeight: 600 }}>{preview2 ? t.thanksPhoto : t.thanks}</p><p style={{ fontSize: 14, color: "var(--lt)", marginTop: 8 }}>ğŸ“‹ {t.onReview}</p></div> : (<div><button onClick={() => setView("detail")} style={{ background: "none", border: "none", color: "var(--md)", cursor: "pointer", fontSize: 15, padding: "8px 0", fontWeight: 600 }}>â† {t.back}</button><h2 style={{ fontFamily: FH, fontSize: 22, margin: "8px 0 4px" }}>{t.addInfoTitle}</h2>{sel && <p style={{ color: "var(--lt)", fontSize: 14, margin: "0 0 20px" }}>{sel.name}</p>}<div style={{ display: "flex", flexDirection: "column", gap: 14 }}><PhotoPicker preview={preview2} setPreview={setPreview2} label={t.addPhoto} subLabel={t.photoSelected} /><label style={{ fontSize: 13, fontWeight: 700, color: "#5c4a3a" }}>{t.yourName}<input value={info.yourName} onChange={e => setInfo({...info, yourName: e.target.value})} /></label><label style={{ fontSize: 13, fontWeight: 700, color: "#5c4a3a" }}>{t.comment}<textarea value={info.comment} onChange={e => setInfo({...info, comment: e.target.value})} rows={3} style={{ resize: "vertical" }} /></label><button onClick={submitInfo} disabled={(!info.comment && !preview2) || saving} style={{ padding: 14, background: (!info.comment && !preview2) ? "#c4b59a" : "var(--gn)", color: "#fff", border: "none", borderRadius: 10, fontSize: 16, fontWeight: 700, cursor: (!info.comment && !preview2) ? "default" : "pointer" }}>{saving ? t.saving : t.submit}</button></div></div>)}</div>)}
    {view === "detail" && sel && (() => { const c = CATS.find(x => x.id === sel.cat) || CATS[4]; return (<div style={{ padding: 16 }}><button onClick={() => { setSel(null); setView("list"); }} style={{ background: "none", border: "none", color: "var(--md)", cursor: "pointer", fontSize: 15, padding: "8px 0", fontWeight: 600 }}>â† {t.back}</button><div style={{ background: "var(--cd)", border: "1px solid var(--br)", borderRadius: 14, padding: 22, boxShadow: "0 2px 12px rgba(108,88,76,0.07)" }}><div style={{ display: "flex", alignItems: "center", gap: 12, marginBottom: 14 }}><span style={{ fontSize: 38 }}>{c.icon}</span><div><h2 style={{ margin: 0, fontFamily: FH, fontSize: 21 }}>{sel.name}</h2><span style={{ color: c.color, fontSize: 13, fontWeight: 600 }}>{cn(c)}</span></div></div><div style={{ display: "flex", flexWrap: "wrap", gap: 6, marginBottom: 14 }}>{(sel.subs||[]).map(s => pill(c.color+"15", c.color, sn(sel.cat, s)))}</div><p style={{ lineHeight: 1.65, margin: "0 0 14px", fontSize: 15, fontFamily: FH }}>{sel[lang]}</p><div style={{ display: "flex", flexDirection: "column", gap: 9, padding: "14px 0", borderTop: "1px solid var(--br)" }}><div style={{ display: "flex", alignItems: "flex-start", gap: 8 }}><span>ğŸ“</span><span style={{ fontSize: 14 }}>{sel.addr}</span></div><div style={{ display: "flex", alignItems: "center", gap: 8 }}><span>ğŸ•</span><span style={{ fontSize: 14 }}>{sel["h"+lang]}</span></div><div>{sel.phone ? <span style={{ fontSize: 13, color: "var(--gn)", background: "var(--gb)", padding: "4px 10px", borderRadius: 6, fontWeight: 600 }}>ğŸ“ {sel.phone}</span> : <span style={{ fontSize: 13, color: "var(--lt)", background: "#f5f0e8", padding: "4px 10px", borderRadius: 6, fontWeight: 600 }}>ğŸ“­ {t.visit}</span>}</div></div>{sel.photos?.length > 0 && <div style={{ marginTop: 14, paddingTop: 14, borderTop: "1px solid var(--br)" }}><p style={{ fontSize: 14, fontWeight: 700, margin: "0 0 10px" }}>ğŸ“¸ {t.photos} ({sel.photos.length})</p><div style={{ display: "flex", gap: 8, overflowX: "auto", paddingBottom: 8 }}>{sel.photos.map((p,i) => <div key={i} style={{ flexShrink: 0, width: 170, borderRadius: 10, overflow: "hidden", border: "1px solid var(--br)", background: "#fff" }}><img src={p.url} alt="" style={{ width: 170, height: 120, objectFit: "cover", display: "block" }} />{p.status === "pending" && <div style={{ background: "#f59e0b", color: "#fff", fontSize: 11, fontWeight: 700, textAlign: "center", padding: "4px 0" }}>â³ {t.onReview}</div>}{p.caption && <div style={{ padding: "5px 8px", fontSize: 12, color: "var(--lt)" }}>{p.caption}</div>}</div>)}</div></div>}<div style={{ marginTop: 16, display: "flex", flexDirection: "column", gap: 8 }}><button onClick={() => window.open("https://www.google.com/maps/search/?api=1&query="+encodeURIComponent(sel.addr),"_blank")} style={{ width: "100%", padding: 13, background: c.color, color: "#fff", border: "none", borderRadius: 10, fontSize: 15, fontWeight: 700, cursor: "pointer" }}>ğŸ—ºï¸ {t.map}</button><button onClick={() => { setView("addInfo"); setOk(false); setInfo({ yourName: "", comment: "" }); setPreview2(null); }} style={{ width: "100%", padding: 14, background: "#f0ebe3", color: "#5c4a3a", border: "3px solid #8b7355", borderRadius: 10, fontSize: 16, fontWeight: 700, cursor: "pointer", display: "flex", alignItems: "center", justifyContent: "center", gap: 8 }}><span style={{ fontSize: 22 }}>ğŸ“·</span> {t.photoAndInfo}</button></div></div></div>); })()}
    {(view === "home" || view === "list") && <><div style={{ background: "linear-gradient(145deg, #3d2c1e 0%, #5c4a3a 50%, #6c584c 100%)", padding: "26px 18px 20px", borderRadius: "0 0 22px 22px", position: "relative", overflow: "hidden" }}><div style={{ position: "absolute", top: -30, right: -30, fontSize: 140, opacity: 0.05, transform: "rotate(-15deg)", pointerEvents: "none" }}>ğŸŒ¾</div><div style={{ display: "flex", justifyContent: "space-between", alignItems: "flex-start", position: "relative", zIndex: 1 }}><div><h1 style={{ margin: 0, fontFamily: FH, color: "#f5f0e8", fontSize: 24 }}>ğŸ¡ Country Directory</h1><p style={{ margin: "4px 0 0", color: "#c4b59a", fontSize: 13, fontWeight: 500 }}>{t.subtitle}</p></div><LangSw dark /></div><div style={{ marginTop: 14 }}><input type="text" placeholder={"ğŸ” "+t.search} value={q} onChange={e => { setQ(e.target.value); if (e.target.value && view==="home") setView("list"); }} style={{ boxShadow: "0 2px 8px rgba(0,0,0,0.1)" }} /></div></div><div style={{ padding: "14px 16px 20px" }}>{view === "home" && !q && <div><p style={{ color: "var(--lt)", fontSize: 14, marginBottom: 12, textAlign: "center", fontWeight: 600 }}>{t.choose}</p><div style={{ display: "grid", gridTemplateColumns: "1fr 1fr", gap: 10 }}>{CATS.map(c => <button key={c.id} onClick={() => { setCatF(c.id); setView("list"); }} style={{ background: "var(--cd)", border: "2px solid "+c.color+"22", borderRadius: 14, padding: "16px 12px", cursor: "pointer", textAlign: "center", transition: "all .15s" }} onMouseOver={e => { e.currentTarget.style.borderColor=c.color; e.currentTarget.style.transform="translateY(-2px)"; }} onMouseOut={e => { e.currentTarget.style.borderColor=c.color+"22"; e.currentTarget.style.transform="none"; }}><div style={{ fontSize: 30, marginBottom: 4 }}>{c.icon}</div><div style={{ fontFamily: FH, fontSize: 15 }}>{cn(c)}</div><div style={{ color: c.color, fontSize: 12, marginTop: 4, fontWeight: 700 }}>{stores.filter(s => s.cat===c.id).length} {t.places}</div></button>)}</div><button onClick={() => { setCatF(null); setView("list"); }} style={{ width: "100%", marginTop: 10, padding: 13, background: "var(--dk)", color: "#f5f0e8", border: "none", borderRadius: 10, fontSize: 15, fontWeight: 700, cursor: "pointer" }}>ğŸ“‹ {t.all} ({stores.length})</button><button onClick={() => { setView("addPlace"); setOk(false); setForm({ name: "", addr: "", phone: "", cat: "", desc: "", hours: "" }); setPreview(null); }} style={{ width: "100%", marginTop: 8, padding: 13, background: "#fff", color: "var(--gn)", border: "2px solid var(--gn)", borderRadius: 10, fontSize: 15, fontWeight: 700, cursor: "pointer" }}>â• {t.addPlace}</button><div style={{ marginTop: 16, padding: 14, background: "var(--gb)", borderRadius: 10, border: "1px solid #c8ddb8" }}><p style={{ margin: 0, color: "var(--gn)", fontSize: 13, lineHeight: 1.55, fontWeight: 500 }}>ğŸ’¡ {t.tip}</p></div></div>}{(view === "list" || q) && <div><div style={{ display: "flex", justifyContent: "space-between", alignItems: "center", marginBottom: 10 }}><button onClick={() => { setView("home"); setCatF(null); setQ(""); }} style={{ background: "none", border: "none", color: "var(--md)", cursor: "pointer", fontSize: 14, fontWeight: 600, padding: 0 }}>â† {t.cats}</button><div style={{ display: "flex", gap: 4 }}>{CATS.map(c => <button key={c.id} onClick={() => setCatF(catF===c.id ? null : c.id)} style={{ background: catF===c.id ? c.color : "transparent", color: catF===c.id ? "#fff" : "var(--lt)", border: "1.5px solid "+(catF===c.id ? c.color : "#d4c9b8"), borderRadius: 18, padding: "2px 6px", fontSize: 14, cursor: "pointer" }}>{c.icon}</button>)}</div></div><p style={{ color: "var(--lt)", fontSize: 13, margin: "0 0 10px", fontWeight: 600 }}>{t.found}: {filtered.length}</p>{filtered.length === 0 ? <div style={{ textAlign: "center", padding: 40 }}><div style={{ fontSize: 48 }}>ğŸ”</div><p style={{ fontWeight: 600, color: "var(--lt)" }}>{t.nothing}</p></div> : <div style={{ display: "flex", flexDirection: "column", gap: 8 }}>{filtered.map(s => { const c = CATS.find(x => x.id===s.cat)||CATS[4]; return <button key={s.id} onClick={() => { setSel(s); setView("detail"); }} style={{ background: "var(--cd)", border: "1px solid var(--br)", borderRadius: 12, padding: 13, cursor: "pointer", textAlign: "left", transition: "all .15s" }} onMouseOver={e => e.currentTarget.style.borderColor=c.color} onMouseOut={e => e.currentTarget.style.borderColor="var(--br)"}><div style={{ display: "flex", alignItems: "center", gap: 11 }}><span style={{ fontSize: 26, flexShrink: 0 }}>{c.icon}</span><div style={{ flex: 1, minWidth: 0 }}><div style={{ fontFamily: FH, fontSize: 15 }}>{s.name}</div><div style={{ color: "var(--lt)", fontSize: 12, marginTop: 2, overflow: "hidden", textOverflow: "ellipsis", whiteSpace: "nowrap" }}>ğŸ“ {s.addr}</div><div style={{ display: "flex", gap: 4, marginTop: 5, flexWrap: "wrap", alignItems: "center" }}>{(s.subs||[]).slice(0,3).map(sub => pill(c.color+"12", c.color, sn(s.cat, sub)))}{s.photos?.length > 0 && <span style={{ fontSize: 11, color: "var(--lt)" }}>ğŸ“· {s.photos.length}</span>}</div></div><span style={{ color: "#c4b59a", fontSize: 20, flexShrink: 0 }}>â€º</span></div></button>; })}</div>}<button onClick={() => { setView("addPlace"); setOk(false); setForm({ name: "", addr: "", phone: "", cat: catF||"", desc: "", hours: "" }); setPreview(null); }} style={{ width: "100%", marginTop: 14, padding: 12, background: "#fff", color: "var(--gn)", border: "2px dashed var(--gn)", borderRadius: 10, fontSize: 14, fontWeight: 700, cursor: "pointer" }}>â• {t.addPlace}</button></div>}</div><div style={{ padding: "8px 16px 28px", textAlign: "center" }}><p style={{ color: "#c4b59a", fontSize: 11, fontWeight: 500 }}>{t.footer} ğŸŒ¾</p></div></>}
  </div></>);
}
